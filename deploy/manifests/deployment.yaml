apiVersion: apps/v1
kind: Deployment
metadata:
  name: zen-flow-controller
  namespace: zen-flow-system
  labels:
    app: zen-flow-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zen-flow-controller
  template:
    metadata:
      labels:
        app: zen-flow-controller
    spec:
      serviceAccountName: zen-flow-controller
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: controller
          image: kubezen/zen-flow-controller:0.0.1-alpha
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
          args:
            - --metrics-addr=:8080
            - --webhook-addr=:9443
            - --enable-leader-election=true
            - --leader-election-namespace=zen-flow-system
            - --enable-webhook=true
            - --webhook-cert-file=/etc/webhook/certs/tls.crt
            - --webhook-key-file=/etc/webhook/certs/tls.key
            # For development/testing without cert-manager, use --insecure-webhook=true
            # BUT: webhook configurations must be disabled (failurePolicy: Ignore) or webhooks disabled entirely
            # Production: Use cert-manager to generate certificates (see deploy/webhook/certificate.yaml)
          ports:
            - name: metrics
              containerPort: 8080
              protocol: TCP
            - name: webhook
              containerPort: 9443
              protocol: TCP
          # Webhook cert volume mount (required for TLS, managed by cert-manager)
          volumeMounts:
            - name: webhook-certs
              mountPath: /etc/webhook/certs
              readOnly: true
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
      # Webhook cert volume (managed by cert-manager, see deploy/webhook/certificate.yaml)
      volumes:
        - name: webhook-certs
          secret:
            secretName: zen-flow-webhook-cert

