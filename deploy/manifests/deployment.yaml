apiVersion: apps/v1
kind: Deployment
metadata:
  name: zen-flow-controller
  namespace: zen-flow-system
  labels:
    app: zen-flow-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zen-flow-controller
  template:
    metadata:
      labels:
        app: zen-flow-controller
    spec:
      serviceAccountName: zen-flow-controller
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: controller
          image: kubezen/zen-flow-controller:0.0.1-alpha
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
          args:
            - --metrics-addr=:8080
            - --webhook-addr=:9443
            - --enable-leader-election=true
            - --leader-election-namespace=zen-flow-system
            - --enable-webhook=true
            - --insecure-webhook=true
            # P0.5: For production, ensure zen-flow-webhook-cert secret exists with tls.crt and tls.key
          ports:
            - name: metrics
              containerPort: 8080
              protocol: TCP
            - name: webhook
              containerPort: 9443
              protocol: TCP
          # P0.5: Webhook cert volume mount (optional if using --insecure-webhook=true)
          # volumeMounts:
          #   - name: webhook-certs
          #     mountPath: /etc/webhook/certs
          #     readOnly: true
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
      # P0.5: Webhook cert volume (optional if using --insecure-webhook=true)
      # To generate certs: see docs/WEBHOOK_CERTS.md or use cert-manager
      # volumes:
      #   - name: webhook-certs
      #     secret:
      #       secretName: zen-flow-webhook-cert

