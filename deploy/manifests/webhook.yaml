# P0.6: Validating and Mutating Webhook Configurations for zen-flow
# These webhooks provide validation and mutation for JobFlow resources.
#
# Note: For production use, ensure the caBundle is properly configured.
# If using cert-manager, the caBundle will be injected automatically.
# Otherwise, you need to manually set the caBundle field with the CA certificate.
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: zen-flow-validating-webhook
  labels:
    app: zen-flow-controller
  annotations:
    # Use cert-manager to inject CA bundle automatically
    cert-manager.io/inject-ca-from: zen-flow-system/zen-flow-webhook-cert
webhooks:
  - name: validate-jobflow.workflow.kube-zen.io
    clientConfig:
      service:
        name: zen-flow-controller-metrics
        namespace: zen-flow-system
        path: "/validate-jobflow"
    rules:
      - apiGroups: ["workflow.kube-zen.io"]
        apiVersions: ["v1alpha1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobflows"]
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    failurePolicy: Ignore
    # caBundle is automatically injected by cert-manager via annotation above
    # failurePolicy: Ignore allows resource creation even if webhook is unreachable (safe for alpha)
    # For production with cert-manager, you can change to failurePolicy: Fail for strict validation---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: zen-flow-mutating-webhook
  labels:
    app: zen-flow-controller
  annotations:
    # Use cert-manager to inject CA bundle automatically
    cert-manager.io/inject-ca-from: zen-flow-system/zen-flow-webhook-cert
webhooks:
  - name: mutate-jobflow.workflow.kube-zen.io
    clientConfig:
      service:
        name: zen-flow-controller-metrics
        namespace: zen-flow-system
        path: "/mutate-jobflow"
    rules:
      - apiGroups: ["workflow.kube-zen.io"]
        apiVersions: ["v1alpha1"]
        operations: ["CREATE"]
        resources: ["jobflows"]
    admissionReviewVersions: ["v1", "v1beta1"]
    sideEffects: None
    failurePolicy: Ignore
    # caBundle is automatically injected by cert-manager via annotation above
    # failurePolicy: Ignore allows resource creation even if webhook is unreachable (safe for alpha)
    # For production with cert-manager, you can change to failurePolicy: Fail for strict validation
