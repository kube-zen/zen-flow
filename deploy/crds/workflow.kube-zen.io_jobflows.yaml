apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: jobflows.workflow.kube-zen.io
  annotations:
    "api-approved.kubernetes.io": "unapproved"
spec:
  group: workflow.kube-zen.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required: [steps]
              properties:
                executionPolicy:
                  type: object
                  properties:
                    concurrencyPolicy:
                      type: string
                      enum: [Allow, Forbid, Replace]
                      default: Forbid
                    ttlSecondsAfterFinished:
                      type: integer
                      default: 86400
                    podFailurePolicy:
                      type: object
                      properties:
                        rules:
                          type: array
                          items:
                            type: object
                            properties:
                              action:
                                type: string
                                enum: [FailJob, Ignore, Count]
                              onExitCodes:
                                type: object
                                properties:
                                  containerName:
                                    type: string
                                  operator:
                                    type: string
                                    enum: [In, NotIn]
                                  values:
                                    type: array
                                    items:
                                      type: integer
                    backoffLimit:
                      type: integer
                      default: 6
                    activeDeadlineSeconds:
                      type: integer
                resourceTemplates:
                  type: object
                  properties:
                    volumeClaimTemplates:
                      type: array
                      items:
                        type: object
                    configMapTemplates:
                      type: array
                      items:
                        type: object
                steps:
                  type: array
                  items:
                    type: object
                    required: [name, template]
                    properties:
                      name:
                        type: string
                      type:
                        type: string
                        enum: [Job, Manual]
                        default: Job
                      message:
                        type: string
                      metadata:
                        type: object
                        properties:
                          annotations:
                            type: object
                            additionalProperties:
                              type: string
                          labels:
                            type: object
                            additionalProperties:
                              type: string
                      dependencies:
                        type: array
                        items:
                          type: string
                      retryPolicy:
                        type: object
                        properties:
                          limit:
                            type: integer
                          backoff:
                            type: object
                            properties:
                              type:
                                type: string
                                enum: [Exponential, Linear, Fixed]
                              factor:
                                type: number
                              duration:
                                type: string
                      timeoutSeconds:
                        type: integer
                      when:
                        type: string
                      continueOnFailure:
                        type: boolean
                      template:
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      inputs:
                        type: object
                      outputs:
                        type: object
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: [Pending, Running, Succeeded, Failed, Suspended]
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum: [True, False, Unknown]
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                startTime:
                  type: string
                  format: date-time
                completionTime:
                  type: string
                  format: date-time
                estimatedCompletionTime:
                  type: string
                  format: date-time
                steps:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      phase:
                        type: string
                        enum: [Pending, Running, Succeeded, Failed, Skipped]
                      startTime:
                        type: string
                        format: date-time
                      completionTime:
                        type: string
                        format: date-time
                      jobRef:
                        type: object
                      outputs:
                        type: object
                      retryCount:
                        type: integer
                      message:
                        type: string
                resourceRefs:
                  type: array
                  items:
                    type: object
                progress:
                  type: object
                  properties:
                    completedSteps:
                      type: integer
                    totalSteps:
                      type: integer
                    successfulSteps:
                      type: integer
                    failedSteps:
                      type: integer
                audit:
                  type: object
      subresources:
        status: {}
  scope: Namespaced
  names:
    plural: jobflows
    singular: jobflow
    kind: JobFlow
    shortNames: ["jf", "flow"]
    categories: ["all"]

