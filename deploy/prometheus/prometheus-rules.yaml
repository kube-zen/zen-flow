# Copyright 2025 Kube-ZEN Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: zen-flow-alerts
  namespace: zen-flow-system
  labels:
    app: zen-flow-controller
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: zen-flow.rules
      interval: 30s
      rules:
        # Alert when zen-flow controller is down
        - alert: ZenFlowControllerDown
          expr: up{job="zen-flow-controller"} == 0
          for: 5m
          labels:
            severity: critical
            component: zen-flow-controller
          annotations:
            summary: "zen-flow Controller is down"
            description: "zen-flow Controller has been down for more than 5 minutes."
        # Alert on high reconciliation error rate
        - alert: ZenFlowHighReconciliationErrorRate
          expr: rate(zen_flow_reconciliation_duration_seconds_count[5m]) > 10
          for: 5m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High zen-flow reconciliation rate detected"
            description: >
              zen-flow Controller is experiencing {{ $value }} reconciliations per second.
        # Alert on step execution failures
        - alert: ZenFlowStepExecutionFailures
          expr: rate(zen_flow_step_phase_transitions_total{phase="Failed"}[5m]) > 5
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High step execution failure rate"
            description: >
              zen-flow Controller is failing to execute steps at a high rate.
        # Alert on JobFlow stuck in Running state
        - alert: ZenFlowJobFlowStuck
          expr: zen_flow_jobflows{phase="Running"} > 0
          for: 1h
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "JobFlow stuck in Running state"
            description: >
              JobFlow has been in Running state for more than 1 hour.
        # Alert on JobFlow stuck in Paused state (waiting for approval too long)
        - alert: ZenFlowJobFlowStuckWaitingApproval
          expr: zen_flow_jobflows{phase="Paused"} > 0
          for: 24h
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "JobFlow stuck waiting for manual approval"
            description: >
              JobFlow has been in Paused state waiting for manual approval for more than 24 hours.
              Check for steps with phase PendingApproval and approve them if appropriate.
        # Alert on steps stuck in PendingApproval
        - alert: ZenFlowStepStuckPendingApproval
          expr: zen_flow_steps{phase="PendingApproval"} > 0
          for: 12h
          labels:
            severity: info
            component: zen-flow-controller
          annotations:
            summary: "Step waiting for manual approval"
            description: >
              Step has been waiting for manual approval for more than 12 hours.
              Approve the step using: kubectl annotate jobflow <name> workflow.zen.io/approved/<step-name>=true
        # Alert on slow step execution
        - alert: ZenFlowSlowStepExecution
          expr: >
            histogram_quantile(0.95,
            rate(zen_flow_step_duration_seconds_bucket[5m])) > 300
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "Slow step execution detected"
            description: >
              95th percentile step execution duration is high ({{ $value }}s).
        # Alert on high job creation failure rate
        - alert: ZenFlowHighJobCreationFailureRate
          expr: rate(zen_flow_step_phase_transitions_total{phase="Failed"}[5m]) > 2
          for: 5m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High step failure rate"
            description: >
              zen-flow Controller is experiencing a high rate of step failures.
        # Alert when no JobFlows are active (may indicate issues)
        - alert: ZenFlowNoActiveJobFlows
          expr: zen_flow_jobflows{phase="Running"} == 0 AND zen_flow_jobflows{phase="Pending"} == 0
          for: 1h
          labels:
            severity: info
            component: zen-flow-controller
          annotations:
            summary: "No active JobFlows"
            description: >
              No active JobFlows are configured or running.
              This may be expected if JobFlows are not needed.

