# Copyright 2025 Kube-ZEN Contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: zen-flow-alerts
  namespace: zen-flow-system
  labels:
    app: zen-flow-controller
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
    - name: zen-flow.rules
      interval: 30s
      rules:
        # Alert when zen-flow controller is down
        - alert: ZenFlowControllerDown
          expr: up{job="zen-flow-controller"} == 0
          for: 5m
          labels:
            severity: critical
            component: zen-flow-controller
          annotations:
            summary: "zen-flow Controller is down"
            description: "zen-flow Controller has been down for more than 5 minutes."
        # Alert on high reconciliation rate
        - alert: ZenFlowHighReconciliationRate
          expr: rate(zen_flow_reconciliation_duration_seconds_count[5m]) > 10
          for: 5m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High zen-flow reconciliation rate detected"
            description: >
              zen-flow Controller is experiencing {{ $value }} reconciliations per second.
              This may indicate controller thrashing or high JobFlow activity.
        # Alert on step execution failures
        - alert: ZenFlowStepExecutionFailures
          expr: rate(zen_flow_step_phase_transitions_total{phase="Failed"}[5m]) > 5
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High step execution failure rate"
            description: >
              zen-flow Controller is failing to execute steps at a high rate.
        # Alert on JobFlow stuck in Running state (no progress for 2+ hours)
        - alert: ZenFlowJobFlowStuck
          expr: zen_flow_jobflows{phase="Running"} > 0
          for: 2h
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "JobFlow stuck in Running state"
            description: >
              JobFlow has been in Running state for more than 2 hours.
              This may indicate a stuck workflow or long-running process.
        # Alert on JobFlow stuck in Paused state (waiting for approval too long)
        - alert: ZenFlowJobFlowStuckWaitingApproval
          expr: zen_flow_jobflows{phase="Paused"} > 0
          for: 24h
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "JobFlow stuck waiting for manual approval"
            description: >
              JobFlow has been in Paused state waiting for manual approval for more than 24 hours.
              Check for steps with phase PendingApproval and approve them if appropriate.
        # Alert on steps stuck in PendingApproval
        - alert: ZenFlowStepStuckPendingApproval
          expr: zen_flow_steps{phase="PendingApproval"} > 0
          for: 12h
          labels:
            severity: info
            component: zen-flow-controller
          annotations:
            summary: "Step waiting for manual approval"
            description: >
              Step has been waiting for manual approval for more than 12 hours.
              Approve the step using: kubectl annotate jobflow <name> workflow.kube-zen.io/approved/<step-name>=true
        # Alert on slow step execution
        - alert: ZenFlowSlowStepExecution
          expr: >
            histogram_quantile(0.95,
            rate(zen_flow_step_duration_seconds_bucket[5m])) > 300
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "Slow step execution detected"
            description: >
              95th percentile step execution duration is high ({{ $value }}s).
        # Alert on slow reconciliation (P95 duration)
        - alert: ZenFlowSlowReconciliation
          expr: >
            histogram_quantile(0.95,
            rate(zen_flow_reconciliation_duration_seconds_bucket[5m])) > 5
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "Slow reconciliation detected"
            description: >
              95th percentile reconciliation duration is high ({{ $value }}s).
              This may indicate controller performance issues.
        # Alert on webhook certificate expiration (within 30 days)
        - alert: ZenFlowWebhookCertificateExpiringSoon
          expr: >
            (certmanager_certificate_expiration_timestamp_seconds{namespace="zen-flow-system",name="zen-flow-webhook-cert"} - time()) / 86400 < 30
          for: 1h
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "Webhook certificate expiring soon"
            description: >
              Webhook certificate for zen-flow-controller will expire in {{ $value }} days.
              Ensure cert-manager is configured to automatically renew certificates.
        # Alert on webhook certificate expired
        - alert: ZenFlowWebhookCertificateExpired
          expr: >
            certmanager_certificate_expiration_timestamp_seconds{namespace="zen-flow-system",name="zen-flow-webhook-cert"} < time()
          for: 5m
          labels:
            severity: critical
            component: zen-flow-controller
          annotations:
            summary: "Webhook certificate has expired"
            description: >
              Webhook certificate for zen-flow-controller has expired.
              Webhooks will fail until certificate is renewed.
              Check cert-manager status: kubectl get certificate -n zen-flow-system
        # Alert on webhook certificate not found
        - alert: ZenFlowWebhookCertificateNotFound
          expr: >
            absent(certmanager_certificate_expiration_timestamp_seconds{namespace="zen-flow-system",name="zen-flow-webhook-cert"})
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "Webhook certificate not found"
            description: >
              Webhook certificate for zen-flow-controller not found in cert-manager.
              Check if cert-manager is installed and certificate resource exists.
              Verify: kubectl get certificate -n zen-flow-system
        # Alert on high API server call rate
        - alert: ZenFlowHighAPIServerCallRate
          expr: >
            rate(zen_flow_api_server_calls_total[5m]) > 100
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High API server call rate detected"
            description: >
              zen-flow Controller is making {{ $value }} API server calls per second.
              This may indicate high reconciliation load or inefficient API usage.
        # Alert on high DAG computation time
        - alert: ZenFlowHighDAGComputationTime
          expr: >
            histogram_quantile(0.95,
            rate(zen_flow_dag_computation_duration_seconds_bucket[5m])) > 1
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High DAG computation time detected"
            description: >
              95th percentile DAG computation time is high ({{ $value }}s).
              Consider optimizing JobFlow DAG complexity or increasing resources.
        # Alert on high queue depth
        - alert: ZenFlowHighQueueDepth
          expr: >
            zen_flow_step_execution_queue_depth > 100
          for: 10m
          labels:
            severity: warning
            component: zen-flow-controller
          annotations:
            summary: "High step execution queue depth"
            description: >
              Step execution queue depth is {{ $value }}.
              Consider increasing --max-concurrent-reconciles or optimizing step dependencies.
